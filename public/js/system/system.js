// Generated by CoffeeScript 1.4.0
var hideChat, showChat;

window.App = {
  Models: {},
  Views: {},
  Collections: {},
  InitModels: {},
  InitViews: {},
  InitCollections: {}
};

App.Models.Chat = Backbone.Model.extend({
  urlRoot: '/consultants'
});

App.Views.Chat = Backbone.View.extend({
  el: '#ok_con_web_chat',
  $ok: $('#ok_button'),
  open: false,
  online: false,
  client: {},
  status: 'offline',
  consults: 0,
  initialize: function() {
    console.log('init view chat');
    this.updateSystem();
    return this.registerSocket();
  },
  registerSocket: function() {
    var _this = this;
    console.log("Initialize socket");
    this.socket = io('http://127.0.0.1:1337');
    this.socket.emit('addClient');
    return this.socket.on('takeCountConsultants', function(data) {
      return _this.takeCountConsultants(data);
    });
  },
  takeCountConsultants: function(data) {
    var count;
    console.info('Получили количество консультантов', data);
    if ('count' in data) {
      count = parseInt(data.count);
      if (count) {
        this.online = true;
      } else {
        this.online = false;
      }
    } else {
      this.online = false;
    }
    return this.updateSystem();
  },
  updateSystem: function() {
    if (!this.online) {
      this.status = 'offline';
      return this.switchChatButton(0);
    } else {
      return this.switchChatButton(1);
    }
  },
  switchChatButton: function(command) {
    if (command) {
      console.log('Online');
      this.$ok.removeClass('ok_offline_button');
      return this.$ok.addClass('ok_online_button');
    } else {
      console.log('Offline');
      this.$ok.removeClass('ok_online_button');
      return this.$ok.addClass('ok_offline_button');
    }
  },
  events: {
    'click #ok_button': 'okClick',
    'click #ok_submit': 'okSubmit'
  },
  okSubmit: function(e) {
    var $element, $form, data;
    $element = $(e.currentTarget);
    $form = $element.parent('form');
    data = JSON.stringify($form.serializeArray());
    return console.log(data);
  },
  okClick: function() {
    if (this.open) {
      this.hideChat();
      return this.open = false;
    } else {
      this.showChat();
      return this.open = true;
    }
  },
  showChat: function() {
    var ok_position, template;
    ok_position = 'ok_left_center';
    template = $('#' + this.status + '_tmpl').html();
    $('#iframe').html(template);
    $('#ok_consultant').css('display', 'block');
    switch (ok_position) {
      case 'ok_left_center':
        return $('#ok_con_web_chat').animate({
          'left': '0'
        }, 250);
    }
  },
  hideChat: function() {
    var ok_position;
    ok_position = 'ok_left_center';
    switch (ok_position) {
      case 'ok_left_center':
        return $('#ok_con_web_chat').animate({
          'left': '-340px'
        }, 450, function() {
          return $('#ok_consultant').css('display', 'none');
        });
    }
  }
});

App.InitModels.Chat = new App.Models.Chat();

App.InitViews.Chat = new App.Views.Chat({
  model: App.InitModels.Chat
});

showChat = function(tmpl_name) {
  var ok_position, template;
  ok_position = 'ok_left_center';
  template = $('#' + tmpl_name).html();
  $('#iframe').html(template);
  $('#ok_consultant').css('display', 'block');
  switch (ok_position) {
    case 'ok_left_center':
      return $('#ok_con_web_chat').animate({
        'left': '0'
      }, 250);
  }
};

hideChat = function() {
  var ok_position;
  ok_position = 'ok_left_center';
  switch (ok_position) {
    case 'ok_left_center':
      return $('#ok_con_web_chat').animate({
        'left': '-340px'
      }, 450, function() {
        return $('#ok_consultant').css('display', 'none');
      });
  }
};
